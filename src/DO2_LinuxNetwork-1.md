## Part 1. Инструмент ipcalc

- Поднимаем виртуальную машину (далее ws1)

![Alt text](<Снимок экрана 2025-02-08 в 14.01.04.png>)

### 1.1. Сети и маски

1) Определяем адрес подсети

![Alt text](<Снимок экрана 2025-02-06 в 21.36.04.png>)

![Alt text](<Снимок экрана 2025-02-06 в 21.35.38.png>)



2) Перевод масок

2.1 -- 255.255.255.0 

При помощи ipcalc и любого ip(мы возьмем 8.8.8.8) узнаем другие виды записи 

![Alt text](<Снимок экрана 2025-02-06 в 21.05.49.png>)

![Alt text](<Снимок экрана 2025-02-06 в 21.04.36.png>)

- Префиксная: /24

- Двоичная: 11111111.11111111.11111111.00000000

2.2 -- /15

![Alt text](<Снимок экрана 2025-02-06 в 21.07.25.png>)

![Alt text](<Снимок экрана 2025-02-06 в 21.07.34.png>)

- Обычная: 255.254.0.0

- Двоичная: 11111111.11111110.00000000.00000000

2.3 -- 11111111.11111111.11111111.11110000

Сначала переведем в префиксную запись для удобства посчитав единицы: `/28`, далее при помощи ipcalc узнаем обычную запись: `255.255.255.240`

![Alt text](<Снимок экрана 2025-02-06 в 21.01.14-1.png>)

3) Минимальный и максимальный хост в сети 12.167.38.4 при разных масках

3.1 -- `/8`

![Alt text](<Снимок экрана 2025-02-06 в 20.18.21.png>)

3.2 -- 11111111.11111111.00000000.00000000

 Для удобства переведем в префиксную запись посчитав единицы: `/16`

![Alt text](<Снимок экрана 2025-02-06 в 20.30.07.png>)

3.3 -- 255.255.254.0 
Для удобства переведем в префиксную запись предварительно узнав его при помощи ipcalc: `/23`

![Alt text](<Снимок экрана 2025-02-06 в 20.30.57.png>)

3.4 -- `/4`

![Alt text](<Снимок экрана 2025-02-06 в 21.33.19.png>)

### 1.2. localhost

Для того, чтобы определить можно ли обратиться к приложению, работающему на localhost(127.0.0.1/8), прогоним ip через ipcalc

1) 194.34.23.100

![Alt text](<Снимок экрана 2025-02-06 в 22.51.45.png>)

2) 127.0.0.2

![Alt text](<Снимок экрана 2025-02-06 в 22.54.20.png>)

3) 127.1.0.1

![Alt text](<Снимок экрана 2025-02-06 в 22.53.39.png>)

4) 128.0.0.1

![Alt text](<Снимок экрана 2025-02-06 в 22.53.48.png>)

Если в выводе пункт Network остается `127.0.0.0`, значит, этот IP относится к localhost, и можно обратиться к приложению.

Соответственно, 

194.34.23.100 `не относится` к localhost

127.0.0.2 `относится` к localhost

127.1.0.1 `относится` к localhost

128.0.0.1 `не относится` к localhost

### 1.3. Диапазоны и сегменты сетей

1) Публичные и частные IP

Частные IP-адреса не выбираются случайным образом. У них есть конкретные диапазоны, зарезервированные для локальных сетей. Согласно протоколам IPv4 и IPv6, частные IP-адреса бывают трех категорий:

![Alt text](<Снимок экрана 2025-02-07 в 19.49.20.png>)

Исходя из этих данных, мы можем понять, является ли заданный ip адрес частным или публичным. Так же понять это можно при помощи утилиты `ipcalc`, он указывает является ли адрес частным или публичным по типу:

![Alt text](<Снимок экрана 2025-02-07 в 20.07.37.png>)

`10.0.0.45` → частный 

`134.43.0.2` → публичный

`192.168.4.2` → частный

`172.20.250.4` → частный

`172.0.2.1` → публичный

`192.172.0.1` → публичный

`172.68.0.2` → публичный

`172.16.255.255` → частный

`10.10.10.10` → частный

`192.169.168.1` → публичный

2) Возможные IP шлюза в сети 10.10.0.0/18

Для того, чтобы узнать какие IP шлюза возможны у заданной сети, сначала узнаем диапазон возможных адресов при помощи `ipcalc`. Шлюзом может быть любой IP-адрес в диапазоне сети

![Alt text](<Снимок экрана 2025-02-07 в 20.14.28.png>)

![Alt text](<Снимок экрана 2025-02-07 в 20.15.07.png>)

`10.0.0.1` - Не входит в диапазон

`10.10.0.2` - Входит в диапазон (может быть шлюзом)

`10.10.10.10` - Входит в диапазон (может быть шлюзом)

`10.10.100.1` - Не входит в диапазон 

`10.10.1.255` - Входит в диапазон (может быть шлюзом)

## Part 2. Статическая маршрутизация между двумя машинами

- Поднимаем вторую виртуальную машину (далее ws2)

![Alt text](<Снимок экрана 2025-02-08 в 13.48.58.png>)

- Смотрим список сетевых интерфейсов на ws2

 ![Alt text](<Снимок экрана 2025-02-08 в 14.06.06.png>)

 Интерфейс, относящийся к внутренней сети - это enp0s3

 - Задаем для каждой машины адреса

 1) ws1

 ![Alt text](<Снимок экрана 2025-02-08 в 14.29.36.png>)

 Убеждаемся в изменении адреса

 ![Alt text](<Снимок экрана 2025-02-08 в 14.36.14.png>)

 2) ws2

 ![Alt text](<Снимок экрана 2025-02-08 в 14.29.46.png>)

  Убеждаемся в изменении адреса

  ![Alt text](<Снимок экрана 2025-02-08 в 14.35.43.png>)

 3) Для обеих машин принимаем изменения при помощи:

 >`sudo netplan apply`

 ### 2.1. Добавление статического маршрута вручную

 1) Настраиваем маршрут на ws1 (192.168.100.10/16 → 172.24.116.8/12) при помощи команды  ip r add

 ![Alt text](<Снимок экрана 2025-02-12 в 21.26.51.png>)

Убеждаемся, что машрут построен

![Alt text](<Снимок экрана 2025-02-12 в 21.31.41.png>)

Пингуем

![Alt text](<Снимок экрана 2025-02-12 в 21.18.59.png>)

2) Настраиваем маршрут на ws1 (172.24.116.8/12 → 192.168.100.10/16) при помощи команды  ip r add

![Alt text](<Снимок экрана 2025-02-12 в 21.27.13.png>)

Убеждаемся, что машрут построен

![Alt text](<Снимок экрана 2025-02-12 в 21.34.02.png>)

Пингуем

![Alt text](<Снимок экрана 2025-02-12 в 21.19.47.png>)

 ### 2.2. Добавление статического маршрута с сохранением

 Перезагружаем обе машины при помощи `reboot`

 1) Добавляем статический машрут в файл /etc/netplan/00-installer-config.yaml

 - ws1

 ![Alt text](<Снимок экрана 2025-02-12 в 21.54.02.png>)

 - ws2

 ![Alt text](<Снимок экрана 2025-02-12 в 21.54.33.png>)

 2) Перезагружаемся снова и убеждаемся, что машруты остались

 - ws1

![Alt text](<Снимок экрана 2025-02-12 в 21.59.34.png>)

- ws2

![Alt text](<Снимок экрана 2025-02-12 в 21.59.44.png>)

3) Снова пингуем

-  C ws1

![Alt text](<Снимок экрана 2025-02-12 в 22.02.39.png>)

- C ws2

![Alt text](<Снимок экрана 2025-02-12 в 22.03.10.png>)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

Переводим единицы измерения скорости из одной в другую

![Alt text](<Снимок экрана 2025-02-13 в 20.54.05.png>)

## 3.2. Утилита iperf3

1) Запускаем сервер на ws1 соответствующей командой

![Alt text](<Снимок экрана 2025-02-13 в 21.14.33.png>)

![Alt text](<Снимок экрана 2025-02-13 в 21.14.50.png>)

2) На ws2, которая будет является клиентом, вводим команду

![Alt text](<Снимок экрана 2025-02-13 в 21.15.41.png>)

3) Оцениваем результат

![Alt text](<Снимок экрана 2025-02-13 в 21.17.33.png>)

## Part 4. Сетевой экран

### 4.1. Утилита iptables

- Создаем файл firewall.sh для обеих машин при помощи 
>`sudo touch /etc/firewall.sh`

- Прописываем правила для ws1 и ws2 в соответствии с заданными стратегиями

1) ws1

![Alt text](<Снимок экрана 2025-02-15 в 18.42.55.png>)

2) ws2

![Alt text](<Снимок экрана 2025-02-15 в 18.43.14.png>)

- Прописываем для каждой машины команды 

![Alt text](<Снимок экрана 2025-02-13 в 22.27.10.png>)

- Убеждаемся что правила применились 

1) ws1

![Alt text](<Снимок экрана 2025-02-13 в 22.28.35.png>)

2) ws2

![Alt text](<Снимок экрана 2025-02-13 в 22.29.40.png>)

- Разница в стратегиях состоит в том, что:

На ws1 – сначала всё запрещаем, потом добавляем разрешения. Это более жёсткая стратегия. Метод предпочтителен для защищённых серверов, когда вы хотите быть уверены, что только определённые соединения могут пройти.

На ws2 – сначала всё разрешаем, потом запрещаем ненужные пакеты. Это более мягкий подход, который проще для настройки, но с меньшей степенью безопасности, так как все пакеты разрешены по умолчанию. Но блокировка ненужных пакетов всё же происходит на более поздних этапах.

### 4.2. Проверка nmap

- Пробуем пинговать соединение с ws2 машину ws1

![Alt text](<Снимок экрана 2025-02-15 в 18.44.29.png>)

Пинг не проходит, так мы поставили запрет в прошлом задании

- Убеждаемся, что пинг не проходит из-за правила, а не из-за чего-то иного

![Alt text](<Снимок экрана 2025-02-15 в 18.45.42.png>)

 `Host is up`, значит что хост запущен

 - Сохраняем дампы

 ![Alt text](<Снимок экрана 2025-02-15 в 18.02.37.png>)

 ## Part 5. Статическая маршрутизация сети

 - Поднимаем 5 виртуальных машин

 ![Alt text](<Снимок экрана 2025-02-17 в 21.12.50.png>)

 ### 5.1. Настройка адресов машин

- Настраиваем конфигурации netplan и, после принятия настроек при помощи `sudo netplan apply`, проверяем правильность адреса при помощи 

ip -4 a  для каждой машины:

1) ws22

![Alt text](<Снимок экрана 2025-02-17 в 21.22.59.png>)

2) ws11

![Alt text](<Снимок экрана 2025-02-17 в 21.23.22.png>)

3) ws21

![Alt text](<Снимок экрана 2025-02-17 в 21.23.54.png>)

4) r1

![Alt text](<Снимок экрана 2025-02-17 в 21.24.25.png>)

5) r2

![Alt text](<Снимок экрана 2025-02-17 в 21.24.50.png>)

- Пингуем машины в одной подсети

1) c ws22 на ws21

![Alt text](<Снимок экрана 2025-02-17 в 21.25.23.png>)

2) c r1 на ws11

![Alt text](<Снимок экрана 2025-02-17 в 21.52.35.png>)

### 5.2. Включение переадресации IP-адресов

- Включаем `ip forward` временно, а затем постоянно (через `sysctl.conf` файл) на каждой из виртуальных машин

1) r1

![Alt text](<Снимок экрана 2025-02-18 в 20.02.04.png>)

2) r2

![Alt text](<Снимок экрана 2025-02-18 в 20.03.46.png>)

3) ws11

![Alt text](<Снимок экрана 2025-02-18 в 20.05.35.png>)

4) ws22

![Alt text](<Снимок экрана 2025-02-18 в 20.07.01.png>)

5) ws21

![Alt text](<Снимок экрана 2025-02-18 в 20.08.26.png>)

### 5.3. Установка маршрута по умолчанию

- Меняем файл конфигурации netplan, принимаем его и проверяем при помощи `ip r` каждую рабочую станцию

1) ws11

![Alt text](<Снимок экрана 2025-02-18 в 20.34.15.png>)

2) ws21 

![Alt text](<Снимок экрана 2025-02-18 в 20.34.57.png>)

3) ws22

![Alt text](<Снимок экрана 2025-02-18 в 20.35.44.png>)

4) r1

![Alt text](<Снимок экрана 2025-02-18 в 21.49.26.png>)

5) r2

![Alt text](<Снимок экрана 2025-02-18 в 21.48.52.png>)

- Пингуем с ws11 на r1 и убеждаемся, что пинг доходит при помощи `tcpdump -tn -i enp0s3 icmp`

![Alt text](<Снимок экрана 2025-02-18 в 21.46.47.png>)

### 5.4. Добавление статических маршрутов

- Добавляем в роутеры r1 и r2 статические маршруты в файле конфигураций

1) r1

![Alt text](<Снимок экрана 2025-02-18 в 22.03.52.png>)

2) r2

![Alt text](<Снимок экрана 2025-02-18 в 22.04.03.png>)

- Вводим ip r для каждого роутера

1) r1

![Alt text](<Снимок экрана 2025-02-18 в 22.05.07.png>)

2) r2

![Alt text](<Снимок экрана 2025-02-18 в 22.05.24.png>)

- Вводим команды ip r list с ws11

![Alt text](<Снимок экрана 2025-02-18 в 22.19.16.png>)

Маршрут 0.0.0.0/0 (default) используется только тогда, когда нет более специфичного и точного маршрута.

В случае с 10.10.0.0/18, в таблице маршрутизации уже есть более точный маршрут:

10.10.0.0/18 dev enp0s3 proto kernel scope link src 10.10.0.2
default via 10.10.0.1 dev enp0s3

### 5.5. Построение списка маршрутизаторов

- Запускаем tcpdump на r1

![Alt text](<Снимок экрана 2025-02-22 в 16.04.08.png>)

- На ws11 при помощи `traceroute` получаем список машрутизаторов

![Alt text](<Снимок экрана 2025-02-22 в 16.04.49.png>)

- Смотрим r1

![Alt text](<Снимок экрана 2025-02-22 в 16.03.51.png>)

Утилита traceroute определяет маршрут до целевого узла, отправляя последовательность пакетов с увеличивающимся TTL (Time-To-Live).

Принцип работы состоит в том, что traceroute отправляет ICMP Echo Request (или UDP-пакеты) с TTL = 1. Первый маршрутизатор (R1) получает пакет, уменьшает TTL, и, так как TTL стал 0, отклоняет пакет, отправляя ICMP Time Exceeded обратно. traceroute фиксирует IP-адрес маршрутизатора и увеличивает TTL до 2. Теперь пакет доходит до R2, где TTL снова уменьшается до 0, и R2 отправляет ICMP Time Exceeded. Процесс продолжается, пока пакет не достигнет целевого узла (ws21).

Как итог, traceroute позволяет определить путь до цели, фиксируя IP-адреса всех промежуточных маршрутизаторов на основе ICMP Time Exceeded. Дамп tcpdump на R1 показывает первые шаги этого процесса, когда пакеты с TTL=1 останавливаются, а TTL=2+ уже идут дальше.

### 5.6. Использование протокола ICMP при маршрутизации

- На r1 запустим tcpdump

![Alt text](<Снимок экрана 2025-02-22 в 16.18.33.png>)

- c ws11 пропингуем несуществующий ip

![Alt text](<Снимок экрана 2025-02-22 в 16.18.56.png>)

- Что получаем на r1

![Alt text](<Снимок экрана 2025-02-22 в 16.17.13.png>)

## Part 6. Динамическая настройка IP с помощью DHCP

1) Служба DHCP для r2

- Настройка конфигурации DHCP службы в файле dhcpd.conf на r2

![Alt text](<Снимок экрана 2025-02-22 в 18.39.29.png>)

- Добавляем в resolv.conf nameserver 8.8.8.8

![Alt text](<Снимок экрана 2025-02-22 в 16.56.28.png>)

- Перезагружаем службу DHCP

![Alt text](<Снимок экрана 2025-02-22 в 18.40.18.png>)

- После перезагрузки ws21, проверяем новый ip адрес машины

![Alt text](<Снимок экрана 2025-02-22 в 18.42.23.png>)

- Пингуем c ws22 на ws21 по новому адресу

![Alt text](<Снимок экрана 2025-02-22 в 18.43.55.png>)

2) Служба DHCP для r1

- Задаем на ws11 макадрес согласно заданию

![Alt text](<Снимок экрана 2025-02-22 в 19.09.04.png>)

- Настраиваем конфигурации DHCP службы в файле dhcpd.conf на r1 аналогично r2, НО добавляем выдачу адресов с жесткой привязкой к MAC-адресу (ws11)

![Alt text](<Снимок экрана 2025-02-22 в 20.44.27.png>)

- Так же добавляем в resolv.conf nameserver 8.8.8.8

![Alt text](<Снимок экрана 2025-02-22 в 19.42.24.png>)

- Перезагружаем службу DHCP

![Alt text](<Снимок экрана 2025-02-22 в 19.43.10-1.png>)

- Теперь перезагружаем ws11, проверяем новый ip адрес машины

![Alt text](<Снимок экрана 2025-02-22 в 20.40.22.png>)

3) Обновляем ip адрес на ws21

- Смотрим старый адрес

![Alt text](<Снимок экрана 2025-02-22 в 20.49.09.png>)

- Запрашиваем новый

![Alt text](<Снимок экрана 2025-02-22 в 20.50.04.png>)

- Смотрим новый адрес

![Alt text](<Снимок экрана 2025-02-22 в 20.52.48.png>)


При обновлении ip адреса, мы пользовались: 
1) dynamic-bootp — выдача нового IP из диапазона
>`range 10.20.0.2 10.20.0.50;`

DHCP-сервер выбирал новый адрес из этого диапазона при обновлении аренды.

2) Команда dhclient на клиенте

`sudo dhclient -r enp0s3`  # Освобождение текущего IP

`sudo dhclient enp0s3`     # Запрос нового IP у DHCP-сервера

##  Part 7. NAT

- На ws22 и r1 изменяем файл /etc/apache2/ports.conf, делая Apache2 общедоступным и запускаем сервер

1) ws22

![Alt text](<Снимок экрана 2025-02-24 в 20.22.02.png>)

![Alt text](<Снимок экрана 2025-02-24 в 20.25.28.png>)

2) r1

![Alt text](<Снимок экрана 2025-02-24 в 20.22.41.png>)

![Alt text](<Снимок экрана 2025-02-24 в 20.25.35.png>)

- Настраиваем фаервол на r2

1) Удаляем правила в таблице filter — `iptables -F`

2) Удаленем правила в таблице «NAT» — `iptables -F -t nat`

3) Отбрасываем все маршрутизируемые пакеты — `iptables --policy FORWARD DROP`

![Alt text](<Снимок экрана 2025-02-24 в 21.32.13.png>)

Пробуем передать пакеты через r2 между r1 и ws22

![Alt text](<Снимок экрана 2025-02-24 в 21.34.34.png>)

Неудача, так как мы блокируем пакеты, которые проходят через r2 (маршрутизируемые пакеты).

4) Разрешаем маршрутизацию всех пакетов протокола ICMP - `iptables -A FORWARD -p icmp -j ACCEPT`

![Alt text](<Снимок экрана 2025-02-24 в 21.36.58.png>)

Снова пингуем

![Alt text](<Снимок экрана 2025-02-24 в 21.37.58.png>)

Успешно!

5) Включаем SNAT и DNAT

![Alt text](<Снимок экрана 2025-02-24 в 22.32.15.png>)

6) Проверяем соединение по TCP для SNAT

![Alt text](<Снимок экрана 2025-02-24 в 22.13.45.png>)

7) Проверяем соединение по TCP для DNAT

![Alt text](<Снимок экрана 2025-02-24 в 22.36.08.png>)